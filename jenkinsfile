pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: node
    image: node:23-alpine
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    - name: npm-cache
      mountPath: /root/.npm
  - name: docker
    image: docker:24-dind
    securityContext:
      privileged: true
    command:
    - dockerd-entrypoint.sh
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
    tty: true
    volumeMounts:
    - name: docker-run
      mountPath: /var/run
    - name: docker-storage
      mountPath: /var/lib/docker
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir: {}
  - name: docker-storage
    emptyDir: {}
  - name: docker-run
    emptyDir: {}
  - name: npm-cache
    emptyDir: {}
"""
        }
    }

    tools {
        jdk 'jdk17'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        DOCKER_IMAGE_NAME = 'zomato'
        DOCKER_IMAGE_TAG = 'latest'
        K8S_API_SERVER = 'https://kubernetes.default.svc'
    }

    triggers {
        pollSCM('H/1 * * * *')
        githubPush()
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Git Checkout') {
            steps {
                deleteDir()
                git branch: 'master',
                    credentialsId: 'github-token',
                    url: 'https://github.com/kapilbtech/devops-project-zmt.git'
            }
        }

        stage('Verify Workspace') {
            steps {
                container('node') {
                    sh 'echo "Current Directory: $(pwd)"'
                    sh 'ls -la'
                    sh 'node --version && npm --version'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                container('jnlp') {
                    script {
                        try {
                            withSonarQubeEnv('sonar-scanner') {
                                sh '$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=zomato -Dsonar.projectKey=zomato -Dsonar.sources=.'
                            }
                        } catch (Exception e) {
                            echo "⚠️ SonarQube failed: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                container('jnlp') {
                    script {
                        try {
                            timeout(time: 10, unit: 'MINUTES') {
                                def qg = waitForQualityGate()
                                if (qg.status != 'OK') {
                                    currentBuild.result = 'UNSTABLE'
                                }
                            }
                        } catch (Exception e) {
                            echo "⚠️ Quality Gate failed: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
        }

        stage('Install NPM Dependencies') {
            steps {
                container('node') {
                    sh 'npm install --verbose'
                }
            }
        }

        stage('Trivy File Scan') {
            steps {
                container('jnlp') {
                    script {
                        try {
                            withEnv(["TRIVY_SERVER_URL=http://10.206.223.48:32384"]) {
                                sh 'trivy client $TRIVY_SERVER_URL fs . > trivy.txt || true'
                            }
                        } catch (Exception e) {
                            sh 'echo "Trivy scan failed" > trivy.txt'
                        }
                    }
                }
            }
        }

        stage('Wait for Docker') {
            steps {
                container('docker') {
                    sh 'until [ -S /var/run/docker.sock ]; do sleep 2; done'
                    sh 'docker info'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                container('docker') {
                    sh 'docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .'
                    sh 'docker images | grep ${DOCKER_IMAGE_NAME}'
                }
            }
        }

        stage('Trivy Image Scan') {
            steps {
                container('jnlp') {
                    script {
                        try {
                            withEnv(["TRIVY_SERVER_URL=http://10.206.223.48:32384"]) {
                                sh 'trivy client $TRIVY_SERVER_URL image ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} > trivy-image.txt || true'
                            }
                        } catch (Exception e) {
                            sh 'echo "Trivy image scan failed" > trivy-image.txt'
                        }
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                container('docker') {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                        sh 'docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} $DOCKER_USER/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}'
                        sh 'docker push $DOCKER_USER/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}'
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                container('kubectl') {
                    withCredentials([string(credentialsId: 'k8-token', variable: 'K8S_TOKEN')]) {
                        script {
                            sh 'kubectl config set-cluster kubernetes --server=${K8S_API_SERVER} --insecure-skip-tls-verify=true'
                            sh 'kubectl config set-credentials jenkins --token=${K8S_TOKEN}'
                            sh 'kubectl config set-context jenkins --cluster=kubernetes --user=jenkins'
                            sh 'kubectl config use-context jenkins'
                            sh 'kubectl version --client'
                            
                            def deployFile = sh(
                                script: 'if [ -f "zomato-deployment.yaml" ]; then echo "zomato-deployment.yaml"; elif [ -f "zomato-deployment.yml" ]; then echo "zomato-deployment.yml"; elif [ -f "Kubernetes/zomato-deployment.yml" ]; then echo "Kubernetes/zomato-deployment.yml"; else echo "NOT_FOUND"; fi',
                                returnStdout: true
                            ).trim()
                            
                            if (deployFile == 'NOT_FOUND') {
                                error "Deployment file not found!"
                            }
                            
                            echo "Deploying: ${deployFile}"
                            sh "kubectl apply -f ${deployFile}"
                            sh 'kubectl rollout status deployment/zomato --timeout=5m || true'
                            sh 'kubectl get deployment zomato || true'
                            sh 'kubectl get pods -l app=zomato || true'
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                try {
                    archiveArtifacts artifacts: 'trivy*.txt', allowEmptyArchive: true
                    withCredentials([usernamePassword(credentialsId: 'email-creds', usernameVariable: 'EMAIL_USER', passwordVariable: 'EMAIL_PASS')]) {
                        emailext(
                            to: 'kapilbtech86@gmail.com',
                            from: "${EMAIL_USER}",
                            subject: "✅ SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                            mimeType: 'text/html',
                            attachLog: true,
                            replyTo: "${EMAIL_USER}",
                            body: "<html><body><h2 style='color:green'>Build Successful!</h2><p>Job: ${env.JOB_NAME}</p><p>Build: ${env.BUILD_NUMBER}</p><p>URL: <a href='${env.BUILD_URL}'>${env.BUILD_URL}</a></p></body></html>"
                        )
                    }
                } catch (Exception e) {
                    echo "Post-success failed: ${e.message}"
                }
            }
        }
        
        failure {
            script {
                try {
                    archiveArtifacts artifacts: 'trivy*.txt,*.log', allowEmptyArchive: true
                    withCredentials([usernamePassword(credentialsId: 'email-creds', usernameVariable: 'EMAIL_USER', passwordVariable: 'EMAIL_PASS')]) {
                        emailext(
                            to: 'kapilbtech86@gmail.com',
                            from: "${EMAIL_USER}",
                            subject: "❌ FAILURE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                            mimeType: 'text/html',
                            attachLog: true,
                            replyTo: "${EMAIL_USER}",
                            body: "<html><body><h2 style='color:red'>Build Failed!</h2><p>Job: ${env.JOB_NAME}</p><p>Build: ${env.BUILD_NUMBER}</p><p>Failed Stage: ${env.STAGE_NAME}</p><p>URL: <a href='${env.BUILD_URL}'>${env.BUILD_URL}</a></p></body></html>"
                        )
                    }
                } catch (Exception e) {
                    echo "Post-failure failed: ${e.message}"
                }
            }
        }
        
        unstable {
            script {
                try {
                    archiveArtifacts artifacts: 'trivy*.txt', allowEmptyArchive: true
                    withCredentials([usernamePassword(credentialsId: 'email-creds', usernameVariable: 'EMAIL_USER', passwordVariable: 'EMAIL_PASS')]) {
                        emailext(
                            to: 'kapilbtech86@gmail.com',
                            from: "${EMAIL_USER}",
                            subject: "⚠️ UNSTABLE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                            mimeType: 'text/html',
                            attachLog: true,
                            replyTo: "${EMAIL_USER}",
                            body: "<html><body><h2 style='color:orange'>Build Unstable!</h2><p>Job: ${env.JOB_NAME}</p><p>Build: ${env.BUILD_NUMBER}</p><p>URL: <a href='${env.BUILD_URL}'>${env.BUILD_URL}</a></p></body></html>"
                        )
                    }
                } catch (Exception e) {
                    echo "Post-unstable failed: ${e.message}"
                }
            }
        }
        
        always {
            script {
                echo "Pipeline Status: ${currentBuild.result ?: 'SUCCESS'}"
                try {
                    sh 'rm -rf * .* 2>/dev/null || true'
                } catch (Exception e) {
                    echo "Cleanup warning: ${e.message}"
                }
            }
        }
    }
}
